name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          
      - name: Verify version in manifest
        run: |
          MANIFEST_VERSION=$(grep -oP '(?<=<version>)[^<]+' mod_callnowbutton/mod_callnowbutton.xml)
          if [ "$MANIFEST_VERSION" != "${{ steps.get_version.outputs.VERSION }}" ]; then
            echo "Error: Version mismatch!"
            echo "Tag version: ${{ steps.get_version.outputs.VERSION }}"
            echo "Manifest version: $MANIFEST_VERSION"
            exit 1
          fi
          echo "Version verified: $MANIFEST_VERSION"
          
      - name: Create ZIP archive
        run: |
          echo "Creating ZIP archive for version ${{ steps.get_version.outputs.VERSION }}"
          
          # Create ZIP with only mod_callnowbutton contents (not the folder itself)
          cd mod_callnowbutton
          zip -r ../mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip . \
            -x "*.git*" "*.DS_Store" "*Thumbs.db" "*.idea*" "*node_modules*" "*.vscode*" "*.bak" "*.tmp" \
            -x ".git/*" ".gitignore" ".DS_Store" "Thumbs.db"
          cd ..
          
          # Check if ZIP file was created
          if [ ! -f "mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip" ]; then
            echo "ERROR: ZIP file was not created!"
            exit 1
          fi
          
          ZIP_SIZE=$(ls -lh mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip | awk '{print $5}')
          echo "✅ ZIP file created successfully: mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip ($ZIP_SIZE)"
          
          # Verify ZIP structure (should start with mod_callnowbutton.xml, not mod_callnowbutton/)
          echo "Verifying ZIP structure..."
          echo "First 15 files in ZIP:"
          unzip -l mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip | head -15
          
          # Check that mod_callnowbutton.xml is at root
          if ! unzip -l mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip | grep -q "mod_callnowbutton.xml"; then
            echo "ERROR: mod_callnowbutton.xml not found in ZIP root!"
            exit 1
          fi
          
          # Check that ZIP doesn't contain mod_callnowbutton/ folder
          if unzip -l mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip | grep -q "^.*mod_callnowbutton/"; then
            echo "ERROR: ZIP contains mod_callnowbutton/ folder structure!"
            exit 1
          fi
          
          echo "✅ ZIP structure verified correctly"
          
      - name: Generate checksums
        id: checksums
        run: |
          ZIP_FILE="mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip"
          MD5=$(md5sum $ZIP_FILE | awk '{print $1}')
          SHA256=$(sha256sum $ZIP_FILE | awk '{print $1}')
          SHA512=$(sha512sum $ZIP_FILE | awk '{print $1}')
          SIZE=$(ls -lh $ZIP_FILE | awk '{print $5}')
          
          echo "MD5=$MD5" >> $GITHUB_OUTPUT
          echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA512=$SHA512" >> $GITHUB_OUTPUT
          echo "SIZE=$SIZE" >> $GITHUB_OUTPUT
          
          echo "### Checksums" >> $GITHUB_STEP_SUMMARY
          echo "- **MD5**: \`$MD5\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA256**: \`$SHA256\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA512**: \`$SHA512\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: $SIZE" >> $GITHUB_STEP_SUMMARY
          
      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          
          # Extract changelog from changelog.xml for this version
          CHANGELOG=$(cat updates/changelog.xml | sed -n "/<version>$VERSION<\/version>/,/<\/changelog>/p" | \
            grep -oP '(?<=<item><!\[CDATA\[)[^\]]+(?=\]\]><\/item>)' | \
            sed 's/^/- /' || echo "- Initial release")
          
          # Create formatted changelog
          cat > changelog_temp.md << 'EOF'
          ## What's New in v${{ steps.get_version.outputs.VERSION }}
          
          EOF
          
          # Append extracted changelog
          echo "$CHANGELOG" >> changelog_temp.md
          
          # Add footer
          cat >> changelog_temp.md << 'EOF'
          
          ---
          
          ### Installation
          Download the ZIP file and install via Joomla Extension Manager.
          
          ### Update
          Use **System > Update > Extensions** in Joomla Admin.
          
          ### Developer
          **Mostafa Afrouzi** - [afrouzi.ir](https://afrouzi.ir)
          EOF
          
          cat changelog_temp.md
          
      - name: Update updates.xml
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          REPO="${{ github.repository }}"
          
          # Configure git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Fetch all branches and tags
          git fetch origin
          
          # Checkout main branch
          git checkout -B main origin/main || git checkout -b main
          
          # Update version and download URL in updates.xml
          sed -i "s|<version>.*</version>|<version>$VERSION</version>|" updates/updates.xml
          sed -i "s|releases/download/v[^/]*/|releases/download/v$VERSION/|" updates/updates.xml
          sed -i "s|mod_callnowbutton-[0-9.]*\.zip|mod_callnowbutton-$VERSION.zip|" updates/updates.xml
          
          # Check if there are changes to commit
          git add updates/updates.xml
          if ! git diff --staged --quiet; then
            git commit -m "Update updates.xml for version $VERSION [skip ci]"
            git push origin main
            echo "✅ Successfully updated updates.xml and pushed to main branch"
          else
            echo "No changes to commit in updates.xml"
          fi
          
      - name: Verify ZIP file exists before release
        run: |
          ZIP_FILE="mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip"
          if [ ! -f "$ZIP_FILE" ]; then
            echo "ERROR: ZIP file $ZIP_FILE not found!"
            exit 1
          fi
          echo "✅ ZIP file verified: $ZIP_FILE"
          ls -lh "$ZIP_FILE"
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Call Now Button v${{ steps.get_version.outputs.VERSION }}
          body_path: changelog_temp.md
          files: mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
          generate_release_notes: false
          tag_name: v${{ steps.get_version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Build Summary
        run: |
          echo "## ✅ Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**File**: mod_callnowbutton-${{ steps.get_version.outputs.VERSION }}.zip" >> $GITHUB_STEP_SUMMARY
          echo "**Size**: ${{ steps.checksums.outputs.SIZE }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY

